version: 2.1
orbs:
  node: circleci/node@5.1.0


# Define the jobs we want to run for this project
jobs:
  build:
    docker:
      - image: cimg/node:16.10
    steps:
      - checkout
      - run: echo "this is the build job"
  test:
    docker:
      - image: cimg/node:16.10
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - setup_remote_docker
      - run:
          name: Run tests
          command: |
            cd server
            echo "hello world"
            # Start Fuseki container
            docker run -d -p 127.0.0.1:3030:3030 stain/jena-fuseki
            echo "hello world2"
            # Fetch Docker network gateway IP
            DOCKER_GATEWAY_IP=$(docker network inspect bridge --format='{{(index .IPAM.Config 0).Gateway}}')
            echo "Docker Gateway IP: $DOCKER_GATEWAY_IP"
            # Install dependencies
            npm install
            # Update your test command to use the Docker network gateway IP
            npm test --forceExit --fuseki-url=http://$DOCKER_GATEWAY_IP:3030/


# Orchestrate our job run sequence
workflows:
  build_and_test:
    jobs:
      - build
      - test
