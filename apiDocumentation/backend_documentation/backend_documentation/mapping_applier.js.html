<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: mapping_applier.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: mapping_applier.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { MappingDBProxy, Mapping } = require('../db/mapping.js');
const { FusekiProxy } = require('../db/fuseki.js');
const { ExcelTable } = require('./excel.js');
// const { FUSEKI_URI } = require('../db/config.js');

class MappingApplier {
    constructor(fuseki_db = "Main") {
        this.mapDB = new MappingDBProxy();
        this.fuseki = new FusekiProxy(fuseki_db);
    }

    /**
     * Generates Excel sheets from the Fuseki knowledge base using a set of mappings
     * @param {String[]} uuids list of mappings, one for each Excel sheet
     * @returns {Promise&lt;ExcelTable>} the generated Excel table
     */
    async table_from_mapping(uuids) {
        await this.mapDB.connect();
        let table = new ExcelTable();

        for (const uuid of uuids) {
            const mapping = await this.mapDB.get_mapping_by_uuid(uuid);
            if (!mapping)
                continue;
            const { read_query, name } = mapping;
            const read_result = await this.fuseki.read_data(read_query);
            
            if (read_result.err) {
                throw new Error(`MappingApplier: ${read_result.err}`);
            }

            table.add_data(name, read_result);
        }

        await this.mapDB.disconnect();
        return table;
    }

    /**
     * Updates the Fuseki database using the table data and mapping queries
     * @param {ExcelTable} table 
     * @param {String} mappings
     * @returns {Promise&lt;{error: any, results: boolean}>}
     */
    async update_from_table(table, pairs) {
        await this.mapDB.connect();

        let results = [];
        for (const name of Object.keys(pairs)) {
            const uuid = pairs[name];
            const mapping = await this.mapDB.get_mapping_by_uuid(uuid);
            if (!mapping)
                continue;
            const { read_query } = mapping;
            const old_data = await this.fuseki.read_data(read_query);
            const new_data = table.get_data(name);
            const write_query = mapping.get_write_with_data(new_data, old_data);
            const write_result = await this.fuseki.write_data(write_query);
            results.push(write_result);
        }

        await this.mapDB.disconnect();
        return results;
    }
}

module.exports = { MappingApplier };
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Thu Dec 07 2023 16:45:47 GMT-0800 (Pacific Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
